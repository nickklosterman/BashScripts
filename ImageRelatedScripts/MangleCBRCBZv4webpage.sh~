#!/bin/bash

function convertArchivesIntoWebpageDirectory()
{
    imagesPerPage=$1
    echo "${2}"
    i="${2}"
    echo "inmakestuff=$i" # why aren't we getting anything
    IFS=$( echo -en "\n\b" )  #this changes the file delimiter which is normally a space to a newline so we can deal with files with spaces in them.
    newfilename="blank"
    extension1=${i##*.}
    extension=${extension1,,} #convert to all lower case
    ###
    foldernamept2=${i%.*}       #the name was screwing stuff up cause the following commands weren't cutting the filename correctly. 
    foldernamept1=${foldernamept2%%(*} #<-- use %% bc want to match longest sequence  but this leaves trailing whitespace                     
        foldername=${foldernamept1/%[[:space:]]/} #<-- this removes the trailing whitespace                                    
        echo "Foldernames:-$foldername-$foldernamept1-$foldernamept2"
#https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html                                               
# ${parameter/pattern/string} -->then I use the % to match at the end of 'parameter' and since string is empty we remove the pattern which specifies spaces.                            

        if [ !  -e "$foldername" ]
        then
            echo "creating $foldername directory"
            mkdir "$foldername" #create folder if doesn't exist                      
        fi
########

echo "$extension"	
	if [ "$extension" = "cbr" ]
	then
	    echo "CBR file"
	    unrar x "$i"  -d "$foldername" 1>>/dev/null #this will extract w full path
	    unrar x "$i"  -d 1>>/dev/null #this will extract w full path
	else #assume that its cbz

	    echo "CBZ file"
#	    unzip "$i"  -d "$foldername" 1>>/dev/null #send stdoutput to null
	    unzip "$i"  1>>/dev/null #send stdoutput to null
	fi
}

function createHtml()
{

	for decompressdir in * #"$foldername"
	do 
	    echo "in  decompress dir"
	    pwd
	    if [ -d "$decompressdir" ]
	    then

		echo "Moving into directory $decompressdir"
		cd "$decompressdir"

		echo "creating webpage"
		HTMLpage="00Webpage.html"
		echo "<html><body><title>$foldername</title>" > $HTMLpage
		for image in *.[jJ][Pp][Gg] *.[Gg][Ii][fF] *.[Pp][Nn][Gg]
		do 
#could mogrify here as well.
		    mogrify -resize 800x800 "$image"
		    echo "<hr><img src=\"$image\"><br>" >> "$HTMLpage"

		done
		echo "</body></html>" >> "$HTMLpage" #close out last page                           
	

		echo "Leaving directory $decompressdir"
		cd ..
	    else
		echo "not a dir $decompressdir"	    
	    fi
	done
#	    uploadfiles "$foldername" "$HTMLpage"
	   # cd ../
	}



######################
##Begin Script
######################
echo "This is a simple script to automate the Mangle  (Manga-Kindle) app."

numberOfImagesPerPage=5
while getopts ":n:" OPTIONS 
do
    case ${OPTIONS} in 
	n|-numberofimagesperpage) echo "numperpage ${OPTARG}"
	    numberOfImagesPerPage=${OPTARG};;
    esac
done
#echo $numberOfImagesPerPage
shift $(($OPTIND - 1)) 
# Decrements the argument pointer so it points to next argument.
# $1 now references the first non-option item supplied on the command-line
#+ if one exists.

Number_Of_Expected_Args=1
if [ $# -lt $Number_Of_Expected_Args ]
then 
    echo "Usage: script archive archive ...."
    echo "acting on all cbr/cbz files in this directory"
    for item in *.[Cc][Bb][RrZz]
    do
	echo "--$item--"
	convertArchivesIntoWebpageDirectory $numberOfImagesPerPage "${item}"
    done
else
    until [ -z "$1" ] #loop through all arguments using shift to move through arguments
    do
	echo $1
	convertArchivesIntoWebpageDirectory $numberOfImagesPerPage "${1}"
	shift
    done
fi
createHtml